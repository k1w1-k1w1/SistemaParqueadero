<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin</title>
    <link rel="stylesheet" href="/css/login.css?v=9999" />
    <style>
        /* Layout del panel */
        .dash {
            width: min(1200px, 94vw);
            position: relative;
            z-index: 2;
            animation: pop .55s cubic-bezier(.2,.9,.25,1) both;
        }

        .top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 14px;
        }

        .titleBox h1 {
            margin: 0;
            font-size: 28px;
            letter-spacing: .2px;
        }

        .titleBox .sub {
            color: var(--muted);
            font-size: 14px;
            margin-top: 4px;
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn2 {
            border: 1px solid rgba(15, 23, 42, .12);
            background: rgba(255,255,255,.9);
            color: var(--text);
            padding: 10px 12px;
            border-radius: 14px;
            font-weight: 900;
            cursor: pointer;
            transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
            box-shadow: 0 10px 20px rgba(15,23,42,.06);
        }

            .btn2:hover {
                transform: translateY(-1px);
                border-color: rgba(225,6,0,.25);
                box-shadow: 0 14px 26px rgba(15,23,42,.08);
            }

            .btn2.red {
                border: 0;
                background: linear-gradient(135deg, var(--red), var(--red2));
                color: #fff;
                box-shadow: 0 18px 34px rgba(225, 6, 0, .22);
            }

                .btn2.red:hover {
                    box-shadow: 0 22px 40px rgba(225, 6, 0, .26);
                }

        /* Cards */
        .grid2 {
            display: grid;
            gap: 14px;
            grid-template-columns: 1fr;
        }

        @media(min-width: 980px) {
            .grid2 {
                grid-template-columns: 1.1fr .9fr;
            }
        }

        .panel {
            background: rgba(255,255,255,.85);
            border: 1px solid rgba(15, 23, 42, .10);
            border-radius: 20px;
            box-shadow: 0 30px 70px rgba(15, 23, 42, .12);
            backdrop-filter: blur(10px);
            padding: 16px;
        }

            .panel h2 {
                margin: 0;
                font-size: 18px;
                letter-spacing: .2px;
            }

            .panel .muted {
                color: var(--muted);
                margin-top: 6px;
                font-size: 14px;
            }

        /* Search row */
        .searchRow {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 12px;
            align-items: center;
        }

        .input {
            flex: 1 1 260px;
            border: 1px solid rgba(15, 23, 42, .12);
            border-radius: 14px;
            padding: 12px 12px;
            outline: none;
            background: rgba(255,255,255,.9);
            transition: border-color .2s ease, box-shadow .2s ease, transform .2s ease;
            font-size: 14px;
        }

            .input:focus {
                border-color: rgba(225, 6, 0, .55);
                box-shadow: 0 0 0 6px rgba(225, 6, 0, .10);
                transform: translateY(-1px);
            }

        /* Table */
        .tableWrap {
            margin-top: 12px;
            overflow: auto;
            border-radius: 16px;
            border: 1px solid rgba(15, 23, 42, .10);
            background: rgba(255,255,255,.92);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 920px;
        }

        th, td {
            padding: 12px;
            border-bottom: 1px solid rgba(15, 23, 42, .08);
            text-align: left;
            font-size: 14px;
            white-space: nowrap;
        }

        th {
            position: sticky;
            top: 0;
            background: rgba(255,255,255,.98);
            z-index: 1;
            font-size: 12px;
            letter-spacing: .25px;
            text-transform: uppercase;
            color: rgba(15,23,42,.65);
        }

        tr:hover td {
            background: rgba(225, 6, 0, .03);
        }

        .pill {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid rgba(15, 23, 42, .12);
            font-weight: 900;
            font-size: 12px;
        }

            .pill.role-admin {
                border-color: rgba(225,6,0,.28);
                background: rgba(225,6,0,.06);
                color: rgba(225,6,0,.95);
            }

            .pill.role-op {
                border-color: rgba(37,99,235,.25);
                background: rgba(37,99,235,.06);
                color: #2563eb;
            }

            .pill.role-user {
                border-color: rgba(15,23,42,.14);
                background: rgba(15,23,42,.03);
                color: rgba(15,23,42,.75);
            }

            .pill.on {
                border-color: rgba(5,150,105,.25);
                background: rgba(5,150,105,.08);
                color: #059669;
            }

            .pill.off {
                border-color: rgba(220,38,38,.22);
                background: rgba(220,38,38,.06);
                color: #dc2626;
            }

        .rowBtns {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .mini {
            border: 1px solid rgba(15, 23, 42, .12);
            background: rgba(255,255,255,.9);
            color: rgba(15,23,42,.9);
            padding: 8px 10px;
            border-radius: 12px;
            font-weight: 900;
            font-size: 12px;
            cursor: pointer;
            transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
            box-shadow: 0 8px 16px rgba(15,23,42,.06);
        }

            .mini:hover {
                transform: translateY(-1px);
                border-color: rgba(225,6,0,.20);
                box-shadow: 0 10px 18px rgba(15,23,42,.08);
            }

            .mini.red {
                border: 0;
                background: linear-gradient(135deg, var(--red), var(--red2));
                color: #fff;
                box-shadow: 0 12px 22px rgba(225,6,0,.20);
            }

        .status {
            margin-top: 10px;
            min-height: 18px;
            font-size: 13px;
            color: var(--muted);
        }

            .status.ok {
                color: #059669;
            }

            .status.err {
                color: #dc2626;
            }

        /* Perfil */
        .kv {
            display: grid;
            gap: 10px;
            margin-top: 12px;
        }

            .kv .box {
                border: 1px solid rgba(15,23,42,.10);
                background: rgba(255,255,255,.9);
                border-radius: 16px;
                padding: 12px;
            }

            .kv .k {
                color: var(--muted);
                font-size: 12px;
                text-transform: uppercase;
                letter-spacing: .3px;
            }

            .kv .v {
                font-weight: 900;
                font-size: 18px;
                margin-top: 4px;
            }
    </style>
</head>

<body>
    <main class="auth">
        <section class="dash" aria-label="Panel administrador">
            <div class="top">
                <div class="titleBox">
                    <h1>Administrador</h1>
                    <div class="sub">Gestión de usuarios</div>
                </div>

                <div class="actions">
                    <button class="btn2" id="btnReload">Recargar</button>
                    <button class="btn2 red" id="btnLogout">Salir</button>
                </div>
            </div>

            <div class="grid2">
                <!-- Tabla usuarios -->
                <div class="panel">
                    <h2>Usuarios</h2>
                    <div class="muted">Puedes buscar, cambiar roles y activar/desactivar.</div>

                    <div class="searchRow">
                        <input class="input" id="q" placeholder="Buscar por username..." />
                        <button class="btn2" id="btnBuscar">Buscar</button>
                        <button class="btn2" id="btnLimpiar">Limpiar</button>
                    </div>

                    <div class="tableWrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Nombre</th>
                                    <th>Rol</th>
                                    <th>Activo</th>
                                    <th>Creado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tbody"></tbody>
                        </table>
                    </div>

                    <div class="status" id="status"></div>
                </div>

                <!-- Perfil admin -->
                <div class="panel">
                    <h2>Mi sesión</h2>
                    <div class="muted">Info desde tu JWT.</div>

                    <div class="kv">
                        <div class="box">
                            <div class="k">Username</div>
                            <div class="v" id="meUser">-</div>
                        </div>
                        <div class="box">
                            <div class="k">Rol</div>
                            <div class="v" id="meRole">-</div>
                        </div>
                    </div>

                    <div class="status" id="status2"></div>
                </div>
            </div>
        </section>

        <div class="bg" aria-hidden="true">
            <div class="blob b1"></div>
            <div class="blob b2"></div>
            <div class="grid"></div>
        </div>
    </main>

    <script type="module">
        import { apiFetch } from "/js/api.js";
        import { getRole, getToken, parseJwt, logout } from "/js/auth.js";

        // Guard: solo admin
        const role = getRole();
        if (!role || role !== "Administrador") {
            logout();
        }

        // Perfil
        const token = getToken();
        const payload = token ? parseJwt(token) : null;
        const username =
            payload?.unique_name ||
            payload?.name ||
            payload?.["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"] ||
            "-";

        document.getElementById("meUser").textContent = username;
        document.getElementById("meRole").textContent = role;

        const tbody = document.getElementById("tbody");
        const status = document.getElementById("status");
        const q = document.getElementById("q");

        document.getElementById("btnLogout").addEventListener("click", logout);
        document.getElementById("btnReload").addEventListener("click", () => load());
        document.getElementById("btnBuscar").addEventListener("click", () => load(q.value.trim()));
        document.getElementById("btnLimpiar").addEventListener("click", () => { q.value = ""; load(); });

        function setStatus(text, type = "") {
            status.className = "status " + (type || "");
            status.textContent = text || "";
        }

        function rolePill(rol) {
            if (rol === "Administrador") return '<span class="pill role-admin">Administrador</span>';
            if (rol === "Operador") return '<span class="pill role-op">Operador</span>';
            return '<span class="pill role-user">Usuario</span>';
        }

        function activePill(activo) {
            return activo
                ? '<span class="pill on">Activo</span>'
                : '<span class="pill off">Inactivo</span>';
        }

        function fmt(d) {
            if (!d) return "";
            try { return new Date(d).toLocaleString(); } catch { return d; }
        }

        async function load(search = "") {
            setStatus("Cargando...");
            tbody.innerHTML = "";

            const url = search ? `/api/admin/usuarios?search=${encodeURIComponent(search)}` : "/api/admin/usuarios";
            const res = await apiFetch(url);

            if (!res.ok) {
                const t = await res.text();
                setStatus("No se pudo cargar usuarios.", "err");
                console.error(t);
                return;
            }

            const users = await res.json();
            if (!Array.isArray(users) || users.length === 0) {
                setStatus("Sin resultados.", "");
                return;
            }

            for (const u of users) {
                const tr = document.createElement("tr");
                tr.innerHTML = `
              <td><b>${u.usuarioId}</b></td>
              <td>${escapeHtml(u.username)}</td>
              <td>${escapeHtml(u.nombreCompleto ?? "")}</td>
              <td>${rolePill(u.rol)}</td>
              <td>${activePill(!!u.activo)}</td>
              <td>${fmt(u.fechaCreacion)}</td>
              <td>
                <div class="rowBtns">
                  ${u.rol === "Usuario" ? `<button class="mini red" data-act="rol" data-id="${u.usuarioId}" data-rol="Operador">Hacer Operador</button>` : ""}
                  ${u.rol === "Operador" ? `<button class="mini" data-act="rol" data-id="${u.usuarioId}" data-rol="Usuario">Volver Usuario</button>` : ""}
                  ${u.rol !== "Administrador" && u.activo ? `<button class="mini" data-act="activo" data-id="${u.usuarioId}" data-on="false">Desactivar</button>` : ""}
                  ${u.rol !== "Administrador" && !u.activo ? `<button class="mini" data-act="activo" data-id="${u.usuarioId}" data-on="true">Activar</button>` : ""}
                </div>
              </td>
            `;
                tbody.appendChild(tr);
            }

            setStatus(`Total: ${users.length}`, "ok");
        }

        tbody.addEventListener("click", async (e) => {
            const btn = e.target.closest("button");
            if (!btn) return;

            const act = btn.dataset.act;
            const id = btn.dataset.id;

            if (act === "rol") {
                const rol = btn.dataset.rol;
                await changeRole(id, rol);
                return;
            }

            if (act === "activo") {
                const on = btn.dataset.on === "true";
                await changeActive(id, on);
                return;
            }
        });

        async function changeRole(id, rol) {
            setStatus("Actualizando rol...");
            const res = await apiFetch(`/api/admin/usuarios/${id}/rol`, {
                method: "PUT",
                body: JSON.stringify({ rol })
            });

            const t = await res.text();
            if (!res.ok) {
                setStatus("No se pudo cambiar rol.", "err");
                console.error(t);
                return;
            }

            setStatus("Rol actualizado.", "ok");
            await load(q.value.trim());
        }

        async function changeActive(id, activo) {
            setStatus("Actualizando estado...");
            const res = await apiFetch(`/api/admin/usuarios/${id}/activo`, {
                method: "PUT",
                body: JSON.stringify({ activo })
            });

            const t = await res.text();
            if (!res.ok) {
                setStatus("No se pudo actualizar estado.", "err");
                console.error(t);
                return;
            }

            setStatus("Estado actualizado.", "ok");
            await load(q.value.trim());
        }

        function escapeHtml(str) {
            return (str ?? "").toString()
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        // init
        load();
    </script>
</body>
</html>